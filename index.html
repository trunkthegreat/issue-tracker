<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Issue Tracker</title>
    <style>
        /* main.css - Common shared styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #3a6b1a 25%, #4a7c23 50%, #1a4010 75%, #0f2908 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* Glassmorphic elements */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            background: linear-gradient(45deg, #a8e6cf, #dcedc8, #f8bbd9);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            color: #b8e6b8;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Authentication section */
        .auth-section {
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .token-input {
            width: 100%;
            max-width: 500px;
            padding: 15px 20px;
            margin: 10px 0;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #2d5016;
            font-size: 16px;
            border: 3px solid rgba(168, 230, 207, 0.5);
        }

        .token-input:focus {
            outline: none;
            border-color: #a8e6cf;
            box-shadow: 0 0 20px rgba(168, 230, 207, 0.3);
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            margin: 5px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #a8e6cf, #dcedc8);
            color: #2d5016;
            border-color: #a8e6cf;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(168, 230, 207, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f8bbd9, #ffcccb);
            color: #8b0000;
            border-color: #f8bbd9;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(248, 187, 217, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #90ee90, #98fb98);
            color: #006400;
            border-color: #90ee90;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ffb3ba, #ffc0cb);
            color: #8b0000;
            border-color: #ffb3ba;
        }

        /* Navigation */
        .nav-section {
            padding: 30px;
            margin-bottom: 20px;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .nav-card {
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .nav-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 255, 255, 0.1);
        }

        .nav-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #a8e6cf;
        }

        .nav-card p {
            color: #b8e6b8;
            line-height: 1.5;
        }

        /* Status indicators */
        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
        }

        .status-authenticated {
            background: rgba(144, 238, 144, 0.8);
            color: #006400;
        }

        .status-unauthenticated {
            background: rgba(255, 179, 186, 0.8);
            color: #8b0000;
        }

        /* Scrollable containers */
        .scrollable {
            max-height: 70vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(168, 230, 207, 0.5) transparent;
        }

        .scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .scrollable::-webkit-scrollbar-thumb {
            background: rgba(168, 230, 207, 0.5);
            border-radius: 10px;
        }

        .scrollable::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 230, 207, 0.7);
        }

        /* Hidden sections */
        .hidden {
            display: none;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .nav-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Issue forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #a8e6cf;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #2d5016;
            font-size: 14px;
            border: 2px solid rgba(168, 230, 207, 0.3);
        }

        .form-control:focus {
            outline: none;
            border-color: #a8e6cf;
            box-shadow: 0 0 10px rgba(168, 230, 207, 0.3);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Media preview */
        .media-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px;
            border: 2px solid rgba(168, 230, 207, 0.5);
        }

        /* Issue cards */
        .issue-card {
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid #a8e6cf;
        }

        .issue-card:hover {
            transform: translateX(10px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.1);
        }

        .issue-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #a8e6cf;
            margin-bottom: 8px;
        }

        .issue-meta {
            font-size: 0.9em;
            color: #b8e6b8;
            margin-bottom: 10px;
        }

        .issue-content {
            color: #ffffff;
            line-height: 1.5;
            margin-bottom: 10px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Search */
        .search-container {
            margin-bottom: 30px;
            padding: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #2d5016;
            font-size: 16px;
            border: 3px solid rgba(168, 230, 207, 0.5);
        }

        /* Voice recording */
        .voice-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .recording-indicator {
            width: 20px;
            height: 20px;
            background: #ff0000;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>🌿 GitHub Issue Tracker</h1>
        <p>Comprehensive Issue Management System</p>
    </div>

    <div class="container">
        <!-- Authentication Section -->
        <div class="glass auth-section" id="authSection">
            <h2>GitHub Authentication</h2>
            <p>Enter your GitHub Personal Access Token to enable repository access</p>
            <div style="margin: 20px 0;">
                <input type="password" class="token-input" id="githubToken" placeholder="Enter GitHub Personal Access Token">
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="authenticateToken()">Authenticate</button>
                    <button class="btn btn-secondary" onclick="clearToken()">Clear Token</button>
                </div>
            </div>
            <div id="authStatus">
                <span class="status status-unauthenticated">Not Authenticated</span>
            </div>
        </div>

        <!-- Navigation Section -->
        <div class="glass nav-section" id="navSection">
            <h2 style="text-align: center; margin-bottom: 30px; color: #a8e6cf;">Application Modules</h2>
            <div class="nav-grid">
                <div class="glass-dark nav-card" onclick="showDashboard()">
                    <h3>📊 Dashboard</h3>
                    <p>Overview of all issues and quick access to main functions</p>
                </div>
                <div class="glass-dark nav-card" onclick="showIssueLogger()">
                    <h3>📝 Issue Logger</h3>
                    <p>Log new issues, search, filter and manage existing issues</p>
                </div>
                <div class="glass-dark nav-card" onclick="showReport()">
                    <h3>📈 Reports</h3>
                    <p>View closed issue reports and analytics</p>
                </div>
                <div class="glass-dark nav-card" onclick="showIssueViewer()">
                    <h3>👁️ Issue Viewer</h3>
                    <p>View detailed issues with associated media</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="glass scrollable hidden" id="dashboardSection">
            <div style="padding: 30px;">
                <h2 style="color: #a8e6cf; margin-bottom: 20px;">📊 Dashboard</h2>
                <div id="dashboardContent">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="glass-dark" style="padding: 20px; text-align: center;">
                            <h3 style="color: #a8e6cf;">Total Issues</h3>
                            <div style="font-size: 2em; color: #ffffff;" id="totalIssues">0</div>
                        </div>
                        <div class="glass-dark" style="padding: 20px; text-align: center;">
                            <h3 style="color: #a8e6cf;">Open Issues</h3>
                            <div style="font-size: 2em; color: #ffffff;" id="openIssues">0</div>
                        </div>
                        <div class="glass-dark" style="padding: 20px; text-align: center;">
                            <h3 style="color: #a8e6cf;">Closed Issues</h3>
                            <div style="font-size: 2em; color: #ffffff;" id="closedIssues">0</div>
                        </div>
                    </div>
                    
                    <h3 style="color: #a8e6cf; margin-bottom: 15px;">Recent Issues</h3>
                    <div id="recentIssues"></div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="showIssueLogger()">📝 Create New Issue</button>
                        <button class="btn btn-success" onclick="refreshData()">🔄 Refresh Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Logger Section -->
        <div class="glass scrollable hidden" id="issueLoggerSection">
            <div style="padding: 30px;">
                <h2 style="color: #a8e6cf; margin-bottom: 20px;">📝 Issue Logger</h2>
                
                <!-- Search Section -->
                <div class="search-container glass-dark">
                    <h3 style="color: #a8e6cf; margin-bottom: 15px;">🔍 Search Issues</h3>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search issues (supports multiple keywords separated by commas)...">
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="searchIssues()">Search</button>
                        <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                    </div>
                </div>

                <!-- Create New Issue Form -->
                <div class="glass-dark" style="padding: 30px; margin-bottom: 30px;">
                    <h3 style="color: #a8e6cf; margin-bottom: 20px;">Create New Issue</h3>
                    <form id="issueForm">
                        <div class="form-group">
                            <label for="issueTitle">Issue Title</label>
                            <input type="text" class="form-control" id="issueTitle" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="issueContent">Issue Content</label>
                            <textarea class="form-control" id="issueContent" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="resolutionMethod">Resolution Method</label>
                            <textarea class="form-control" id="resolutionMethod"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="expectedDate">Expected Resolution Date</label>
                            <input type="datetime-local" class="form-control" id="expectedDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="actualDate">Actual Resolution Date</label>
                            <input type="datetime-local" class="form-control" id="actualDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="issueStatus">Status</label>
                            <select class="form-control" id="issueStatus">
                                <option value="ongoing">Ongoing</option>
                                <option value="finished">Finished</option>
                                <option value="pending">Pending</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select class="form-control" id="category">
                                <option value="general">General</option>
                                <option value="bug">Bug</option>
                                <option value="feature">Feature Request</option>
                                <option value="documentation">Documentation</option>
                                <option value="support">Support</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="mediaFiles">Upload Media Files</label>
                            <input type="file" class="form-control" id="mediaFiles" multiple accept="image/*,audio/*">
                            <div id="mediaPreview" style="margin-top: 15px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Voice Recording</label>
                            <div class="voice-controls">
                                <button type="button" class="btn btn-danger" id="recordBtn" onclick="toggleRecording()">🎤 Start Recording</button>
                                <button type="button" class="btn btn-secondary" id="stopBtn" onclick="stopRecording()" disabled>⏹️ Stop</button>
                                <button type="button" class="btn btn-primary" id="playBtn" onclick="playRecording()" disabled>▶️ Play</button>
                                <div id="recordingIndicator" class="recording-indicator hidden"></div>
                            </div>
                            <audio id="audioPreview" controls style="width: 100%; margin-top: 10px; display: none;"></audio>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn btn-success">💾 Save Issue</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">🔄 Reset Form</button>
                        </div>
                    </form>
                </div>

                <!-- Issues List -->
                <div class="glass-dark" style="padding: 30px;">
                    <h3 style="color: #a8e6cf; margin-bottom: 20px;">Issues List</h3>
                    <div id="issuesList"></div>
                </div>
            </div>
        </div>

        <!-- Report Section -->
        <div class="glass scrollable hidden" id="reportSection">
            <div style="padding: 30px;">
                <h2 style="color: #a8e6cf; margin-bottom: 20px;">📈 Closed Issues Report</h2>
                <div id="reportContent">
                    <div class="glass-dark" style="padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #a8e6cf;">Report Summary</h3>
                        <div id="reportSummary"></div>
                    </div>
                    <div class="glass-dark" style="padding: 20px;">
                        <h3 style="color: #a8e6cf;">Closed Issues Details</h3>
                        <div id="closedIssuesList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Viewer Section -->
        <div class="glass scrollable hidden" id="issueViewerSection">
            <div style="padding: 30px;">
                <h2 style="color: #a8e6cf; margin-bottom: 20px;">👁️ Issue Viewer</h2>
                <div id="issueViewerContent">
                    <p style="text-align: center; color: #b8e6b8;">Select an issue to view details</p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn btn-primary" onclick="showDashboard()">📊 Dashboard</button>
            <button class="btn btn-primary" onclick="showIssueLogger()">📝 Issue Logger</button>
            <button class="btn btn-primary" onclick="showReport()">📈 Reports</button>
            <button class="btn btn-primary" onclick="showIssueViewer()">👁️ Issue Viewer</button>
        </div>
    </div>

    <script>
        // Global variables
        let githubToken = localStorage.getItem('githubToken') || '';
        let isAuthenticated = false;
        let issues = [];
        let database = {
            categories: [
                { id: 'general', name: 'General', description: 'General issues' },
                { id: 'bug', name: 'Bug', description: 'Software bugs' },
                { id: 'feature', name: 'Feature Request', description: 'New feature requests' },
                { id: 'documentation', name: 'Documentation', description: 'Documentation issues' },
                { id: 'support', name: 'Support', description: 'Support requests' }
            ]
        };
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudio = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            if (githubToken) {
                document.getElementById('githubToken').value = githubToken;
                authenticateToken();
            }
            loadIssues();
            updateDashboard();
            showDashboard();
        });

        // Authentication functions
        function authenticateToken() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                alert('Please enter a GitHub token');
                return;
            }

            // Validate token by testing GitHub API
            fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            })
            .then(response => {
                if (response.ok) {
                    githubToken = token;
                    localStorage.setItem('githubToken', token);
                    isAuthenticated = true;
                    updateAuthStatus();
                    loadIssues();
                } else {
                    throw new Error('Invalid token');
                }
            })
            .catch(error => {
                alert('Authentication failed: ' + error.message);
                isAuthenticated = false;
                updateAuthStatus();
            });
        }

        function clearToken() {
            githubToken = '';
            localStorage.removeItem('githubToken');
            isAuthenticated = false;
            document.getElementById('githubToken').value = '';
            updateAuthStatus();
        }

        function updateAuthStatus() {
            const statusElement = document.getElementById('authStatus');
            if (isAuthenticated) {
                statusElement.innerHTML = '<span class="status status-authenticated">✅ Authenticated</span>';
            } else {
                statusElement.innerHTML = '<span class="status status-unauthenticated">❌ Not Authenticated</span>';
            }
        }

        // Navigation functions
        function hideAllSections() {
            const sections = ['dashboardSection', 'issueLoggerSection', 'reportSection', 'issueViewerSection'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function showDashboard() {
            hideAllSections();
            document.getElementById('dashboardSection').classList.remove('hidden');
            updateDashboard();
        }

        function showIssueLogger() {
            hideAllSections();
            document.getElementById('issueLoggerSection').classList.remove('hidden');
            displayIssues();
        }

        function showReport() {
            hideAllSections();
            document.getElementById('reportSection').classList.remove('hidden');
            generateReport();
        }

        function showIssueViewer() {
            hideAllSections();
            document.getElementById('issueViewerSection').classList.remove('hidden');
        }

        // Issue management functions
        function generateIssueId() {
            return 'issue_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getCurrentDateTime() {
            return new Date().toISOString();
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Not set';
            return new Date(dateString).toLocaleString();
        }

        // Form handling
        document.getElementById('issueForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!isAuthenticated) {
                alert('Please authenticate with GitHub first');
                return;
            }

            const formData = new FormData(this);
            const issue = {
                id: generateIssueId(),
                title: document.getElementById('issueTitle').value,
                content: document.getElementById('issueContent').value,
                resolutionMethod: document.getElementById('resolutionMethod').value,
                expectedDate: document.getElementById('expectedDate').value,
                actualDate: document.getElementById('actualDate').value,
                status: document.getElementById('issueStatus').value,
                category: document.getElementById('category').value,
                createdDate: getCurrentDateTime(),
                updatedDate: getCurrentDateTime(),
                mediaFiles: [],
                voiceRecording: recordedAudio ? recordedAudio : null
            };

            // Handle media files
            const mediaFiles = document.getElementById('mediaFiles').files;
            const promises = [];

            for (let file of mediaFiles) {
                promises.push(convertFileToBase64(file));
            }

            Promise.all(promises).then(base64Files => {
                issue.mediaFiles = base64Files;
                saveIssue(issue);
            });
        });

        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    resolve({
                        name: file.name,
                        type: file.type,
                        data: reader.result
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function saveIssue(issue) {
            issues.push(issue);
            saveIssuesToStorage();
            displayIssues();
            updateDashboard();
            resetForm();
            alert('Issue saved successfully!');
        }

        function resetForm() {
            document.getElementById('issueForm').reset();
            document.getElementById('mediaPreview').innerHTML = '';
            recordedAudio = null;
            updateVoiceButtons();
        }

        // Media preview
        document.getElementById('mediaFiles').addEventListener('change', function(e) {
            const preview = document.getElementById('mediaPreview');
            preview.innerHTML = '';

            for (let file of e.target.files) {
                const div = document.createElement('div');
                div.style.display = 'inline-block';
                div.style.margin = '10px';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'media-preview';
                    div.appendChild(img);
                } else if (file.type.startsWith('audio/')) {
                    const audio = document.createElement('audio');
                    audio.src = URL.createObjectURL(file);
                    audio.controls = true;
                    audio.style.width = '200px';
                    div.appendChild(audio);
                }

                const name = document.createElement('p');
                name.textContent = file.name;
                name.style.color = '#a8e6cf';
                name.style.fontSize = '12px';
                name.style.textAlign = 'center';
                div.appendChild(name);

                preview.appendChild(div);
            }
        });

        // Voice recording functions
        function toggleRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Voice recording is not supported in this browser');
                return;
            }

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const reader = new FileReader();
                        reader.onload = () => {
                            recordedAudio = {
                                name: 'voice_recording_' + Date.now() + '.wav',
                                type: 'audio/wav',
                                data: reader.result
                            };
                            
                            const audioPreview = document.getElementById('audioPreview');
                            audioPreview.src = URL.createObjectURL(audioBlob);
                            audioPreview.style.display = 'block';
                            updateVoiceButtons();
                        };
                        reader.readAsDataURL(audioBlob);
                        
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    updateVoiceButtons();
                    document.getElementById('recordingIndicator').classList.remove('hidden');
                })
                .catch(error => {
                    alert('Error accessing microphone: ' + error.message);
                });
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('recordingIndicator').classList.add('hidden');
                updateVoiceButtons();
            }
        }

        function playRecording() {
            const audioPreview = document.getElementById('audioPreview');
            if (audioPreview.src) {
                audioPreview.play();
            }
        }

        function updateVoiceButtons() {
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const playBtn = document.getElementById('playBtn');

            const isRecording = mediaRecorder && mediaRecorder.state === 'recording';
            
            recordBtn.disabled = isRecording;
            stopBtn.disabled = !isRecording;
            playBtn.disabled = !recordedAudio;

            if (isRecording) {
                recordBtn.textContent = '🎤 Recording...';
                recordBtn.className = 'btn btn-danger';
            } else {
                recordBtn.textContent = '🎤 Start Recording';
                recordBtn.className = 'btn btn-success';
            }
        }

        // Search functionality
        function searchIssues() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) {
                displayIssues();
                return;
            }

            const keywords = query.split(',').map(k => k.trim()).filter(k => k);
            const filteredIssues = issues.filter(issue => {
                const searchText = (issue.title + ' ' + issue.content + ' ' + issue.resolutionMethod).toLowerCase();
                return keywords.some(keyword => searchText.includes(keyword));
            });

            displayIssues(filteredIssues);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            displayIssues();
        }

        // Display functions
        function displayIssues(issuesToDisplay = issues) {
            const container = document.getElementById('issuesList');
            
            if (issuesToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #b8e6b8;">No issues found</p>';
                return;
            }

            const html = issuesToDisplay.map(issue => `
                <div class="issue-card glass-dark" onclick="viewIssueDetails('${issue.id}')">
                    <div class="issue-title">${escapeHtml(issue.title)}</div>
                    <div class="issue-meta">
                        Created: ${formatDateTime(issue.createdDate)} | 
                        Status: <span class="status status-${issue.status === 'finished' ? 'authenticated' : 'unauthenticated'}">${issue.status}</span> |
                        Category: ${issue.category}
                    </div>
                    <div class="issue-content">${escapeHtml(issue.content)}</div>
                    ${issue.mediaFiles && issue.mediaFiles.length > 0 ? `<div style="color: #a8e6cf; font-size: 0.9em;">📎 ${issue.mediaFiles.length} media file(s)</div>` : ''}
                    ${issue.voiceRecording ? '<div style="color: #a8e6cf; font-size: 0.9em;">🎤 Voice recording available</div>' : ''}
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function viewIssueDetails(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;

            showIssueViewer();
            
            const content = document.getElementById('issueViewerContent');
            content.innerHTML = `
                <div class="glass-dark" style="padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #a8e6cf;">${escapeHtml(issue.title)}</h3>
                        <div>
                            <button class="btn btn-primary" onclick="editIssue('${issue.id}')">✏️ Edit</button>
                            <button class="btn btn-danger" onclick="deleteIssue('${issue.id}')">🗑️ Delete</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #a8e6cf;">Status:</strong> 
                        <span class="status status-${issue.status === 'finished' ? 'authenticated' : 'unauthenticated'}">${issue.status}</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #a8e6cf;">Category:</strong> ${issue.category}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #a8e6cf;">Created:</strong> ${formatDateTime(issue.createdDate)}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #a8e6cf;">Updated:</strong> ${formatDateTime(issue.updatedDate)}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #a8e6cf;">Expected Resolution:</strong> ${formatDateTime(issue.expectedDate)}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #a8e6cf;">Actual Resolution:</strong> ${formatDateTime(issue.actualDate)}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #a8e6cf;">Content:</strong>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-top: 10px; white-space: pre-wrap;">${escapeHtml(issue.content)}</div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #a8e6cf;">Resolution Method:</strong>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-top: 10px; white-space: pre-wrap;">${escapeHtml(issue.resolutionMethod || 'Not specified')}</div>
                    </div>
                    
                    ${issue.mediaFiles && issue.mediaFiles.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <strong style="color: #a8e6cf;">Media Files:</strong>
                            <div style="margin-top: 10px;">
                                ${issue.mediaFiles.map((file, index) => `
                                    <div style="display: inline-block; margin: 10px; text-align: center;">
                                        ${file.type.startsWith('image/') ? 
                                            `<img src="${file.data}" class="media-preview" alt="${file.name}">` :
                                            `<audio controls style="width: 200px;"><source src="${file.data}" type="${file.type}"></audio>`
                                        }
                                        <p style="color: #a8e6cf; font-size: 12px; margin-top: 5px;">${file.name}</p>
                                        <button class="btn btn-danger" style="font-size: 10px; padding: 5px 10px;" onclick="removeMediaFile('${issue.id}', ${index})">Remove</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${issue.voiceRecording ? `
                        <div style="margin-bottom: 20px;">
                            <strong style="color: #a8e6cf;">Voice Recording:</strong>
                            <div style="margin-top: 10px;">
                                <audio controls style="width: 100%;">
                                    <source src="${issue.voiceRecording.data}" type="${issue.voiceRecording.type}">
                                </audio>
                                <button class="btn btn-danger" style="margin-top: 10px;" onclick="removeVoiceRecording('${issue.id}')">Remove Voice Recording</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function editIssue(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;

            showIssueLogger();

            // Populate form with issue data
            document.getElementById('issueTitle').value = issue.title;
            document.getElementById('issueContent').value = issue.content;
            document.getElementById('resolutionMethod').value = issue.resolutionMethod || '';
            document.getElementById('expectedDate').value = issue.expectedDate ? issue.expectedDate.slice(0, 16) : '';
            document.getElementById('actualDate').value = issue.actualDate ? issue.actualDate.slice(0, 16) : '';
            document.getElementById('issueStatus').value = issue.status;
            document.getElementById('category').value = issue.category;

            // Remove the issue from the array (it will be re-added when the form is submitted)
            deleteIssue(issueId, false);
        }

        function deleteIssue(issueId, confirm = true) {
            if (confirm && !window.confirm('Are you sure you want to delete this issue?')) {
                return;
            }

            issues = issues.filter(i => i.id !== issueId);
            saveIssuesToStorage();
            displayIssues();
            updateDashboard();
            
            if (confirm) {
                alert('Issue deleted successfully!');
                showIssueLogger();
            }
        }

        function removeMediaFile(issueId, fileIndex) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;

            issue.mediaFiles.splice(fileIndex, 1);
            issue.updatedDate = getCurrentDateTime();
            saveIssuesToStorage();
            viewIssueDetails(issueId);
        }

        function removeVoiceRecording(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;

            issue.voiceRecording = null;
            issue.updatedDate = getCurrentDateTime();
            saveIssuesToStorage();
            viewIssueDetails(issueId);
        }

        // Dashboard functions
        function updateDashboard() {
            const totalIssues = issues.length;
            const openIssues = issues.filter(i => i.status !== 'finished').length;
            const closedIssues = issues.filter(i => i.status === 'finished').length;

            document.getElementById('totalIssues').textContent = totalIssues;
            document.getElementById('openIssues').textContent = openIssues;
            document.getElementById('closedIssues').textContent = closedIssues;

            // Show recent issues
            const recentIssues = issues.slice(-5).reverse();
            const recentContainer = document.getElementById('recentIssues');
            
            if (recentIssues.length === 0) {
                recentContainer.innerHTML = '<p style="text-align: center; color: #b8e6b8;">No issues found</p>';
                return;
            }

            const html = recentIssues.map(issue => `
                <div class="issue-card glass-dark" onclick="viewIssueDetails('${issue.id}')">
                    <div class="issue-title">${escapeHtml(issue.title)}</div>
                    <div class="issue-meta">
                        ${formatDateTime(issue.createdDate)} | 
                        <span class="status status-${issue.status === 'finished' ? 'authenticated' : 'unauthenticated'}">${issue.status}</span>
                    </div>
                </div>
            `).join('');

            recentContainer.innerHTML = html;
        }

        // Report functions
        function generateReport() {
            const closedIssues = issues.filter(i => i.status === 'finished');
            const totalResolutionTime = closedIssues.reduce((total, issue) => {
                if (issue.createdDate && issue.actualDate) {
                    const created = new Date(issue.createdDate);
                    const resolved = new Date(issue.actualDate);
                    return total + (resolved - created);
                }
                return total;
            }, 0);

            const avgResolutionTime = closedIssues.length > 0 ? totalResolutionTime / closedIssues.length : 0;
            const avgDays = Math.round(avgResolutionTime / (1000 * 60 * 60 * 24));

            const summary = document.getElementById('reportSummary');
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="color: #a8e6cf; font-weight: bold;">Total Closed</div>
                        <div style="font-size: 1.5em; color: #ffffff;">${closedIssues.length}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #a8e6cf; font-weight: bold;">Avg Resolution Time</div>
                        <div style="font-size: 1.5em; color: #ffffff;">${avgDays} days</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #a8e6cf; font-weight: bold;">Resolution Rate</div>
                        <div style="font-size: 1.5em; color: #ffffff;">${issues.length > 0 ? Math.round((closedIssues.length / issues.length) * 100) : 0}%</div>
                    </div>
                </div>
            `;

            const closedList = document.getElementById('closedIssuesList');
            if (closedIssues.length === 0) {
                closedList.innerHTML = '<p style="text-align: center; color: #b8e6b8;">No closed issues found</p>';
                return;
            }

            const html = closedIssues.map(issue => `
                <div class="issue-card glass-dark" onclick="viewIssueDetails('${issue.id}')">
                    <div class="issue-title">${escapeHtml(issue.title)}</div>
                    <div class="issue-meta">
                        Closed: ${formatDateTime(issue.actualDate)} | 
                        Category: ${issue.category}
                    </div>
                    <div class="issue-content">${escapeHtml(issue.content)}</div>
                </div>
            `).join('');

            closedList.innerHTML = html;
        }

        // Storage functions
        function saveIssuesToStorage() {
            localStorage.setItem('githubIssues', JSON.stringify(issues));
        }

        function loadIssues() {
            const stored = localStorage.getItem('githubIssues');
            if (stored) {
                issues = JSON.parse(stored);
            }
        }

        function refreshData() {
            loadIssues();
            updateDashboard();
            displayIssues();
            alert('Data refreshed successfully!');
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize voice recording buttons
        updateVoiceButtons();
    </script>
</body>
</html>
