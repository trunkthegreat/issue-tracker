<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Viewer - Issue Tracker</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Main Content -->
    <div class="glass-container">
        <div class="header">
            <h1><i class="fas fa-eye"></i> Issue Viewer</h1>
            <p>View, Edit & Manage Issue Details</p>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <a href="index.html" class="nav-btn">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="issuelogger.html" class="nav-btn">
                <i class="fas fa-plus-circle"></i> Log Issues
            </a>
            <a href="report.html" class="nav-btn">
                <i class="fas fa-chart-bar"></i> Reports
            </a>
        </div>

        <!-- Issue Selection -->
        <div class="issue-selector" id="issueSelector">
            <div class="selector-header">
                <h2><i class="fas fa-list"></i> Select Issue to View</h2>
                <div class="search-container">
                    <input type="text" id="selectorSearch" class="search-input" placeholder="Search issues...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <div id="issuesList" class="issues-list">
                <!-- Issues will be loaded here -->
            </div>
        </div>

        <!-- Issue Details -->
        <div class="issue-details" id="issueDetails" style="display: none;">
            <div class="details-header">
                <div class="details-title">
                    <h2 id="issueTitle">Issue Title</h2>
                    <div class="issue-actions">
                        <button onclick="editIssue()" class="btn" id="editBtn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="duplicateIssue()" class="btn btn-success">
                            <i class="fas fa-copy"></i> Duplicate
                        </button>
                        <button onclick="deleteIssue()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button onclick="backToList()" class="btn btn-warning">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </button>
                    </div>
                </div>
                
                <div class="issue-metadata">
                    <div class="meta-grid">
                        <div class="meta-item">
                            <span class="meta-label">Status:</span>
                            <span id="issueStatus" class="meta-value"></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Category:</span>
                            <span id="issueCategory" class="meta-value"></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Created:</span>
                            <span id="issueCreated" class="meta-value"></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Expected Resolution:</span>
                            <span id="issueExpected" class="meta-value"></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Actual Resolution:</span>
                            <span id="issueActual" class="meta-value"></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Issue ID:</span>
                            <span id="issueId" class="meta-value"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Issue Content -->
            <div class="content-section">
                <h3><i class="fas fa-align-left"></i> Description</h3>
                <div id="issueContent" class="content-display"></div>
            </div>

            <!-- Resolution Method -->
            <div class="resolution-section">
                <h3><i class="fas fa-tools"></i> Resolution Method</h3>
                <div id="issueResolution" class="content-display"></div>
            </div>

            <!-- Media Section -->
            <div class="media-section">
                <h3><i class="fas fa-paperclip"></i> Attachments</h3>
                
                <!-- Images -->
                <div class="media-subsection" id="imagesSection" style="display: none;">
                    <h4><i class="fas fa-images"></i> Images</h4>
                    <div id="imageGallery" class="image-gallery"></div>
                </div>

                <!-- Audio -->
                <div class="media-subsection" id="audioSection" style="display: none;">
                    <h4><i class="fas fa-microphone"></i> Audio Recordings</h4>
                    <div id="audioGallery" class="audio-gallery"></div>
                </div>
            </div>

            <!-- Comments/Notes Section -->
            <div class="comments-section">
                <h3><i class="fas fa-comments"></i> Notes & Comments</h3>
                <div id="commentsList" class="comments-list"></div>
                
                <div class="add-comment">
                    <textarea id="newComment" class="form-control" placeholder="Add a note or comment..."></textarea>
                    <button onclick="addComment()" class="btn">
                        <i class="fas fa-plus"></i> Add Note
                    </button>
                </div>
            </div>

            <!-- Activity Timeline -->
            <div class="timeline-section">
                <h3><i class="fas fa-history"></i> Activity Timeline</h3>
                <div id="activityTimeline" class="timeline"></div>
            </div>
        </div>

        <!-- Edit Form Modal -->
        <div id="editModal" class="token-container" style="display: none;">
            <div class="token-form" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <h2>Edit Issue</h2>
                
                <form id="editForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editTitle">Title:</label>
                            <input type="text" id="editTitle" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editCategory">Category:</label>
                            <select id="editCategory" class="form-control"></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editContent">Description:</label>
                        <textarea id="editContent" class="form-control" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editResolution">Resolution Method:</label>
                        <textarea id="editResolution" class="form-control"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editExpected">Expected Resolution Date:</label>
                            <input type="date" id="editExpected" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editActual">Actual Resolution Date:</label>
                            <input type="date" id="editActual" class="form-control">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editStatus">Status:</label>
                        <select id="editStatus" class="form-control">
                            <option value="ongoing">Ongoing</option>
                            <option value="finished">Finished</option>
                        </select>
                    </div>

                    <!-- Media Management -->
                    <div class="media-management">
                        <h4><i class="fas fa-paperclip"></i> Manage Attachments</h4>
                        
                        <!-- Add New Images -->
                        <div class="media-upload">
                            <p>Add New Images:</p>
                            <input type="file" id="editImageInput" accept="image/*" multiple style="margin-bottom: 15px;">
                            <div id="editImagePreview" class="media-preview"></div>
                        </div>

                        <!-- Voice Recording -->
                        <div class="voice-section">
                            <h5><i class="fas fa-microphone"></i> Add Voice Recording</h5>
                            <div class="audio-controls">
                                <button type="button" id="editRecordBtn" class="record-btn" onclick="toggleEditRecording()">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <span id="editRecordingStatus">Click to start recording</span>
                                <span id="editRecordingTime">00:00</span>
                            </div>
                            <div id="editAudioPreview" class="media-preview"></div>
                        </div>

                        <!-- Existing Media -->
                        <div class="existing-media">
                            <h5>Existing Attachments:</h5>
                            <div id="existingImages" class="existing-media-grid"></div>
                            <div id="existingAudio" class="existing-media-grid"></div>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: 30px;">
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" onclick="cancelEdit()" class="btn btn-warning">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Image Lightbox -->
        <div id="imageLightbox" class="lightbox" style="display: none;" onclick="closeLightbox()">
            <div class="lightbox-content">
                <img id="lightboxImage" src="" alt="">
                <button class="lightbox-close" onclick="closeLightbox()">×</button>
                <div class="lightbox-nav">
                    <button onclick="previousImage()" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                    <button onclick="nextImage()" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <style>
        .issue-selector {
            margin-bottom: 30px;
        }

        .selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .selector-header h2 {
            margin: 0;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .issues-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .issue-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .issue-card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .issue-details {
            margin-top: 30px;
        }

        .details-header {
            margin-bottom: 30px;
        }

        .details-title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .details-title h2 {
            margin: 0;
            color: #ffffff;
            flex: 1;
            min-width: 300px;
        }

        .issue-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .issue-actions .btn {
            padding: 8px 16px;
            font-size: 14px;
            min-width: auto;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .meta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .meta-label {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .meta-value {
            color: #ffffff;
            font-weight: 500;
        }

        .content-section, .resolution-section, .media-section, .comments-section, .timeline-section {
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .content-section h3, .resolution-section h3, .media-section h3, .comments-section h3, .timeline-section h3 {
            margin-bottom: 20px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-display {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .media-subsection {
            margin-bottom: 25px;
        }

        .media-subsection h4 {
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .image-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .image-item:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .image-item .delete-media {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-item:hover .delete-media {
            opacity: 1;
        }

        .audio-gallery {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .audio-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .audio-item audio {
            flex: 1;
        }

        .audio-item .delete-media {
            background: var(--error);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .comments-list {
            margin-bottom: 20px;
        }

        .comment-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .comment-content {
            color: #ffffff;
            line-height: 1.6;
        }

        .add-comment {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .add-comment textarea {
            flex: 1;
            min-height: 80px;
        }

        .add-comment .btn {
            min-width: 120px;
            height: fit-content;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--accent-orange), var(--accent-pink));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -37px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--pastel-mint);
            border-radius: 50%;
            border: 3px solid var(--primary-green);
        }

        .timeline-time {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .timeline-action {
            font-weight: 600;
            color: #ffffff;
        }

        .media-management {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .existing-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .existing-media-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .existing-media-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .lightbox-nav .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            transition: all 0.3s ease;
        }

        .lightbox-nav .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .issues-list {
                grid-template-columns: 1fr;
            }
            
            .details-title {
                flex-direction: column;
                align-items: stretch;
            }
            
            .details-title h2 {
                min-width: auto;
                margin-bottom: 15px;
            }
            
            .issue-actions {
                justify-content: center;
            }
            
            .meta-grid {
                grid-template-columns: 1fr;
            }
            
            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .add-comment {
                flex-direction: column;
                align-items: stretch;
            }
            
            .selector-header {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>

    <script>
        // Global variables
        let issues = [];
        let categories = {};
        let currentIssue = null;
        let currentImageIndex = 0;
        let filteredIssues = [];
        let editMediaRecorder = null;
        let editRecordingChunks = [];
        let editRecordingTimer = null;
        let editRecordingStartTime = 0;
        let editAttachedImages = [];
        let editAttachedAudio = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
        });

        function initializePage() {
            loadLocalData();
            populateCategoryOptions();
            
            // Check if issue ID is provided in URL
            const urlParams = new URLSearchParams(window.location.search);
            const issueId = urlParams.get('id');
            
            if (issueId) {
                const issue = issues.find(i => i.id === issueId);
                if (issue) {
                    selectIssue(issue);
                } else {
                    showNotification('Issue not found', 'error');
                    displayIssuesList();
                }
            } else {
                displayIssuesList();
            }
        }

        function setupEventListeners() {
            // Search
            document.getElementById('selectorSearch').addEventListener('input', filterIssuesList);
            
            // Edit form
            document.getElementById('editForm').addEventListener('submit', saveEditedIssue);
            document.getElementById('editImageInput').addEventListener('change', handleEditImageUpload);
        }

        function loadLocalData() {
            const storedIssues = localStorage.getItem('issues');
            const storedCategories = localStorage.getItem('categories');

            if (storedIssues) {
                issues = JSON.parse(storedIssues);
            }

            if (storedCategories) {
                categories = JSON.parse(storedCategories);
            } else {
                categories = {
                    'bug': { name: 'Bug Reports', color: '#f44336' },
                    'feature': { name: 'Feature Requests', color: '#2196f3' },
                    'improvement': { name: 'Improvements', color: '#ff9800' },
                    'question': { name: 'Questions', color: '#9c27b0' },
                    'other': { name: 'Other', color: '#607d8b' }
                };
            }

            filteredIssues = [...issues];
        }

        function populateCategoryOptions() {
            const editCategory = document.getElementById('editCategory');
            editCategory.innerHTML = '';

            for (const [key, category] of Object.entries(categories)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = category.name;
                editCategory.appendChild(option);
            }
        }

        function displayIssuesList() {
            document.getElementById('issueSelector').style.display = 'block';
            document.getElementById('issueDetails').style.display = 'none';
            
            const issuesList = document.getElementById('issuesList');
            issuesList.innerHTML = '';

            if (filteredIssues.length === 0) {
                issuesList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; opacity: 0.7;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>No issues found.</p>
                    </div>
                `;
                return;
            }

            filteredIssues
                .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime))
                .forEach(issue => {
                    const issueCard = createIssueCard(issue);
                    issuesList.appendChild(issueCard);
                });
        }

        function createIssueCard(issue) {
            const card = document.createElement('div');
            card.className = 'issue-card';
            card.onclick = () => selectIssue(issue);

            const statusClass = issue.status === 'ongoing' ? 'status-ongoing' : 'status-finished';
            const formattedDate = new Date(issue.dateTime).toLocaleDateString();
            const categoryName = categories[issue.category]?.name || issue.category || 'Other';

            // Media indicators
            const mediaIndicators = [];
            if (issue.pictures && issue.pictures.length > 0) {
                mediaIndicators.push(`<i class="fas fa-image"></i> ${issue.pictures.length}`);
            }
            if (issue.voiceRecords && issue.voiceRecords.length > 0) {
                mediaIndicators.push(`<i class="fas fa-microphone"></i> ${issue.voiceRecords.length}`);
            }

            card.innerHTML = `
                <div class="issue-title">${escapeHtml(issue.title)}</div>
                <div class="issue-meta">
                    <span class="meta-item ${statusClass}">${issue.status}</span>
                    <span class="meta-item">${formattedDate}</span>
                    <span class="meta-item">${categoryName}</span>
                    ${mediaIndicators.length > 0 ? `<span class="meta-item">${mediaIndicators.join(' ')}</span>` : ''}
                </div>
                <div class="issue-content">${escapeHtml(issue.content.substring(0, 150))}${issue.content.length > 150 ? '...' : ''}</div>
            `;

            return card;
        }

        function filterIssuesList() {
            const query = document.getElementById('selectorSearch').value.toLowerCase().trim();
            
            if (!query) {
                filteredIssues = [...issues];
            } else {
                filteredIssues = issues.filter(issue => {
                    const searchText = `${issue.title} ${issue.content}`.toLowerCase();
                    return searchText.includes(query);
                });
            }

            displayIssuesList();
        }

        function selectIssue(issue) {
            currentIssue = issue;
            displayIssueDetails();
            
            // Update URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('id', issue.id);
            window.history.pushState({}, '', newUrl);
        }

        function displayIssueDetails() {
            document.getElementById('issueSelector').style.display = 'none';
            document.getElementById('issueDetails').style.display = 'block';

            // Basic info
            document.getElementById('issueTitle').textContent = currentIssue.title;
            document.getElementById('issueStatus').textContent = currentIssue.status;
            document.getElementById('issueStatus').className = `meta-value ${currentIssue.status === 'ongoing' ? 'status-ongoing' : 'status-finished'}`;
            document.getElementById('issueCategory').textContent = categories[currentIssue.category]?.name || currentIssue.category || 'Other';
            document.getElementById('issueCreated').textContent = new Date(currentIssue.dateTime).toLocaleString();
            document.getElementById('issueExpected').textContent = currentIssue.expectedResolutionDate ? 
                new Date(currentIssue.expectedResolutionDate).toLocaleDateString() : 'Not set';
            document.getElementById('issueActual').textContent = currentIssue.actualResolutionDate ? 
                new Date(currentIssue.actualResolutionDate).toLocaleDateString() : 'Not completed';
            document.getElementById('issueId').textContent = currentIssue.id;

            // Content
            document.getElementById('issueContent').textContent = currentIssue.content || 'No description provided.';
            document.getElementById('issueResolution').textContent = currentIssue.resolutionMethod || 'No resolution method specified.';

            // Media
            displayMedia();
            
            // Comments
            displayComments();
            
            // Activity timeline
            displayTimeline();
        }

        function displayMedia() {
            const imagesSection = document.getElementById('imagesSection');
            const audioSection = document.getElementById('audioSection');
            const imageGallery = document.getElementById('imageGallery');
            const audioGallery = document.getElementById('audioGallery');

            // Images
            if (currentIssue.pictures && currentIssue.pictures.length > 0) {
                imagesSection.style.display = 'block';
                imageGallery.innerHTML = '';
                
                currentIssue.pictures.forEach((image, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.onclick = () => openLightbox(index);
                    
                    imageItem.innerHTML = `
                        <img src="${image.data}" alt="${image.name}">
                        <button class="delete-media" onclick="event.stopPropagation(); deleteImage(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    imageGallery.appendChild(imageItem);
                });
            } else {
                imagesSection.style.display = 'none';
            }

            // Audio
            if (currentIssue.voiceRecords && currentIssue.voiceRecords.length > 0) {
                audioSection.style.display = 'block';
                audioGallery.innerHTML = '';
                
                currentIssue.voiceRecords.forEach((audio, index) => {
                    const audioItem = document.createElement('div');
                    audioItem.className = 'audio-item';
                    
                    audioItem.innerHTML = `
                        <audio controls src="${audio.data}"></audio>
                        <span>${audio.name}</span>
                        <button class="delete-media" onclick="deleteAudio(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    audioGallery.appendChild(audioItem);
                });
            } else {
                audioSection.style.display = 'none';
            }
        }

        function displayComments() {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';

            if (currentIssue.comments && currentIssue.comments.length > 0) {
                currentIssue.comments.forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    
                    commentItem.innerHTML = `
                        <div class="comment-header">
                            <span>${new Date(comment.timestamp).toLocaleString()}</span>
                            <button onclick="deleteComment('${comment.id}')" class="delete-media">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="comment-content">${escapeHtml(comment.content)}</div>
                    `;
                    
                    commentsList.appendChild(commentItem);
                });
            } else {
                commentsList.innerHTML = '<p style="opacity: 0.7; text-align: center;">No notes or comments yet.</p>';
            }
        }

        function displayTimeline() {
            const timeline = document.getElementById('activityTimeline');
            const activities = [];

            // Issue creation
            activities.push({
                timestamp: currentIssue.dateTime,
                action: 'Issue created'
            });

            // Status changes
            if (currentIssue.status === 'finished' && currentIssue.actualResolutionDate) {
                activities.push({
                    timestamp: currentIssue.actualResolutionDate,
                    action: 'Issue resolved'
                });
            }

            // Comments
            if (currentIssue.comments) {
                currentIssue.comments.forEach(comment => {
                    activities.push({
                        timestamp: comment.timestamp,
                        action: 'Note added'
                    });
                });
            }

            // Sort by timestamp
            activities.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            timeline.innerHTML = '';
            activities.forEach(activity => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                timelineItem.innerHTML = `
                    <div class="timeline-time">${new Date(activity.timestamp).toLocaleString()}</div>
                    <div class="timeline-action">${activity.action}</div>
                `;
                
                timeline.appendChild(timelineItem);
            });
        }

        function addComment() {
            const commentText = document.getElementById('newComment').value.trim();
            if (!commentText) {
                showNotification('Please enter a comment', 'error');
                return;
            }

            if (!currentIssue.comments) {
                currentIssue.comments = [];
            }

            const comment = {
                id: Date.now().toString(),
                content: commentText,
                timestamp: new Date().toISOString()
            };

            currentIssue.comments.push(comment);
            saveToLocalStorage();
            
            document.getElementById('newComment').value = '';
            displayComments();
            displayTimeline();
            showNotification('Note added successfully!', 'success');
        }

        function deleteComment(commentId) {
            if (confirm('Are you sure you want to delete this note?')) {
                currentIssue.comments = currentIssue.comments.filter(c => c.id !== commentId);
                saveToLocalStorage();
                displayComments();
                displayTimeline();
                showNotification('Note deleted successfully!', 'success');
            }
        }

        function deleteImage(index) {
            if (confirm('Are you sure you want to delete this image?')) {
                currentIssue.pictures.splice(index, 1);
                saveToLocalStorage();
                displayMedia();
                showNotification('Image deleted successfully!', 'success');
            }
        }

        function deleteAudio(index) {
            if (confirm('Are you sure you want to delete this audio recording?')) {
                currentIssue.voiceRecords.splice(index, 1);
                saveToLocalStorage();
                displayMedia();
                showNotification('Audio recording deleted successfully!', 'success');
            }
        }

        function openLightbox(index) {
            currentImageIndex = index;
            const lightbox = document.getElementById('imageLightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            
            lightboxImage.src = currentIssue.pictures[index].data;
            lightbox.style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('imageLightbox').style.display = 'none';
        }

        function previousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                document.getElementById('lightboxImage').src = currentIssue.pictures[currentImageIndex].data;
            }
        }

        function nextImage() {
            if (currentImageIndex < currentIssue.pictures.length - 1) {
                currentImageIndex++;
                document.getElementById('lightboxImage').src = currentIssue.pictures[currentImageIndex].data;
            }
        }

        function editIssue() {
            // Populate edit form
            document.getElementById('editTitle').value = currentIssue.title;
            document.getElementById('editCategory').value = currentIssue.category || 'other';
            document.getElementById('editContent').value = currentIssue.content;
            document.getElementById('editResolution').value = currentIssue.resolutionMethod || '';
            document.getElementById('editExpected').value = currentIssue.expectedResolutionDate || '';
            document.getElementById('editActual').value = currentIssue.actualResolutionDate || '';
            document.getElementById('editStatus').value = currentIssue.status;

            // Reset edit media arrays
            editAttachedImages = [];
            editAttachedAudio = [];
            
            // Display existing media for management
            displayExistingMedia();
            
            // Show modal
            document.getElementById('editModal').style.display = 'flex';
        }

        function displayExistingMedia() {
            const existingImages = document.getElementById('existingImages');
            const existingAudio = document.getElementById('existingAudio');

            // Existing images
            existingImages.innerHTML = '';
            if (currentIssue.pictures && currentIssue.pictures.length > 0) {
                currentIssue.pictures.forEach((image, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'existing-media-item';
                    
                    imageItem.innerHTML = `
                        <img src="${image.data}" alt="${image.name}">
                        <button class="delete-media" onclick="removeExistingImage(${index})" style="position: absolute; top: 2px; right: 2px;">×</button>
                    `;
                    
                    existingImages.appendChild(imageItem);
                });
            }

            // Existing audio
            existingAudio.innerHTML = '';
            if (currentIssue.voiceRecords && currentIssue.voiceRecords.length > 0) {
                currentIssue.voiceRecords.forEach((audio, index) => {
                    const audioItem = document.createElement('div');
                    audioItem.className = 'audio-item';
                    
                    audioItem.innerHTML = `
                        <audio controls src="${audio.data}"></audio>
                        <span>${audio.name}</span>
                        <button class="delete-media" onclick="removeExistingAudio(${index})">×</button>
                    `;
                    
                    existingAudio.appendChild(audioItem);
                });
            }
        }

        function removeExistingImage(index) {
            currentIssue.pictures.splice(index, 1);
            displayExistingMedia();
        }

        function removeExistingAudio(index) {
            currentIssue.voiceRecords.splice(index, 1);
            displayExistingMedia();
        }

        function handleEditImageUpload(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`File ${file.name} is too large (max 5MB)`, 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        name: file.name,
                        data: e.target.result,
                        type: file.type,
                        size: file.size
                    };
                    
                    editAttachedImages.push(imageData);
                    updateEditImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateEditImagePreview() {
            const preview = document.getElementById('editImagePreview');
            preview.innerHTML = '';

            editAttachedImages.forEach((image, index) => {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'media-item';
                
                imageContainer.innerHTML = `
                    <img src="${image.data}" alt="${image.name}">
                    <button class="remove-media" onclick="removeEditImage(${index})">×</button>
                `;
                
                preview.appendChild(imageContainer);
            });
        }

        function removeEditImage(index) {
            editAttachedImages.splice(index, 1);
            updateEditImagePreview();
        }

        function toggleEditRecording() {
            if (editMediaRecorder && editMediaRecorder.state === 'recording') {
                stopEditRecording();
            } else {
                startEditRecording();
            }
        }

        async function startEditRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                editMediaRecorder = new MediaRecorder(stream);
                editRecordingChunks = [];

                editMediaRecorder.ondataavailable = function(e) {
                    editRecordingChunks.push(e.data);
                };

                editMediaRecorder.onstop = function() {
                    const blob = new Blob(editRecordingChunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const audioData = {
                            name: `recording_${Date.now()}.wav`,
                            data: e.target.result,
                            type: 'audio/wav',
                            size: blob.size
                        };
                        
                        editAttachedAudio.push(audioData);
                        updateEditAudioPreview();
                    };
                    reader.readAsDataURL(blob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };

                editMediaRecorder.start();
                editRecordingStartTime = Date.now();
                
                const recordBtn = document.getElementById('editRecordBtn');
                recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                recordBtn.classList.add('recording');
                
                document.getElementById('editRecordingStatus').textContent = 'Recording...';
                
                editRecordingTimer = setInterval(updateEditRecordingTime, 1000);
                
            } catch (error) {
                showNotification('Could not access microphone', 'error');
            }
        }

        function stopEditRecording() {
            if (editMediaRecorder && editMediaRecorder.state === 'recording') {
                editMediaRecorder.stop();
            }
            
            const recordBtn = document.getElementById('editRecordBtn');
            recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            recordBtn.classList.remove('recording');
            
            document.getElementById('editRecordingStatus').textContent = 'Click to start recording';
            document.getElementById('editRecordingTime').textContent = '00:00';
            
            if (editRecordingTimer) {
                clearInterval(editRecordingTimer);
                editRecordingTimer = null;
            }
        }

        function updateEditRecordingTime() {
            const elapsed = Math.floor((Date.now() - editRecordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('editRecordingTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateEditAudioPreview() {
            const preview = document.getElementById('editAudioPreview');
            preview.innerHTML = '';

            editAttachedAudio.forEach((audio, index) => {
                const audioContainer = document.createElement('div');
                audioContainer.className = 'media-item';
                
                audioContainer.innerHTML = `
                    <audio controls src="${audio.data}"></audio>
                    <button class="remove-media" onclick="removeEditAudio(${index})">×</button>
                    <p style="margin-top: 5px; font-size: 0.9rem;">${audio.name}</p>
                `;
                
                preview.appendChild(audioContainer);
            });
        }

        function removeEditAudio(index) {
            editAttachedAudio.splice(index, 1);
            updateEditAudioPreview();
        }

        function saveEditedIssue(e) {
            e.preventDefault();

            // Update issue data
            currentIssue.title = document.getElementById('editTitle').value.trim();
            currentIssue.category = document.getElementById('editCategory').value;
            currentIssue.content = document.getElementById('editContent').value.trim();
            currentIssue.resolutionMethod = document.getElementById('editResolution').value.trim();
            currentIssue.expectedResolutionDate = document.getElementById('editExpected').value;
            currentIssue.actualResolutionDate = document.getElementById('editActual').value;
            currentIssue.status = document.getElementById('editStatus').value;

            // Add new media
            if (editAttachedImages.length > 0) {
                if (!currentIssue.pictures) currentIssue.pictures = [];
                currentIssue.pictures.push(...editAttachedImages);
            }

            if (editAttachedAudio.length > 0) {
                if (!currentIssue.voiceRecords) currentIssue.voiceRecords = [];
                currentIssue.voiceRecords.push(...editAttachedAudio);
            }

            // Update timestamp
            currentIssue.lastModified = new Date().toISOString();

            // Add activity log
            if (!currentIssue.comments) {
                currentIssue.comments = [];
            }
            currentIssue.comments.push({
                id: Date.now().toString(),
                content: 'Issue updated',
                timestamp: new Date().toISOString()
            });

            // Save and update display
            saveToLocalStorage();
            cancelEdit();
            displayIssueDetails();
            showNotification('Issue updated successfully!', 'success');
        }

        function cancelEdit() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editImagePreview').innerHTML = '';
            document.getElementById('editAudioPreview').innerHTML = '';
            editAttachedImages = [];
            editAttachedAudio = [];
            stopEditRecording();
        }

        function duplicateIssue() {
            const newIssue = {
                ...currentIssue,
                id: Date.now().toString(),
                title: currentIssue.title + ' (Copy)',
                dateTime: new Date().toISOString(),
                status: 'ongoing',
                actualResolutionDate: '',
                comments: []
            };

            issues.push(newIssue);
            saveToLocalStorage();
            showNotification('Issue duplicated successfully!', 'success');
        }

        function deleteIssue() {
            if (confirm(`Are you sure you want to delete the issue "${currentIssue.title}"? This action cannot be undone.`)) {
                const index = issues.findIndex(i => i.id === currentIssue.id);
                if (index !== -1) {
                    issues.splice(index, 1);
                    saveToLocalStorage();
                    showNotification('Issue deleted successfully!', 'success');
                    backToList();
                }
            }
        }

        function backToList() {
            // Remove ID from URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('id');
            window.history.pushState({}, '', newUrl);
            
            // Reload data and show list
            loadLocalData();
            displayIssuesList();
        }

        function saveToLocalStorage() {
            localStorage.setItem('issues', JSON.stringify(issues));
            
            // Update the issues array for list display
            filteredIssues = [...issues];
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
