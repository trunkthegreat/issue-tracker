<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Logger - Issue Tracker</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Token Authentication Modal -->
    <div id="tokenModal" class="token-container" style="display: none;">
        <div class="token-form">
            <h2 style="text-align: center; margin-bottom: 20px;">GitHub Authentication Required</h2>
            <p style="margin-bottom: 20px; opacity: 0.9;">Please enter your GitHub Personal Access Token to enable repository access:</p>
            <div class="form-group">
                <label for="githubToken">GitHub Token:</label>
                <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="authenticateToken()" class="btn" style="flex: 1;">Authenticate</button>
                <button onclick="continueOffline()" class="btn btn-warning" style="flex: 1;">Continue Offline</button>
            </div>
            <p style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> 
                Token is stored locally and used for GitHub API access. 
                <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--pastel-mint);">Generate token here</a>
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="glass-container">
        <div class="header">
            <h1><i class="fas fa-clipboard-list"></i> Issue Logger</h1>
            <p>Create, Search, Filter & Manage Issues</p>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <a href="index.html" class="nav-btn">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="issueviewer.html" class="nav-btn">
                <i class="fas fa-eye"></i> View Issues
            </a>
            <a href="report.html" class="nav-btn">
                <i class="fas fa-chart-bar"></i> Reports
            </a>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search issues... (supports multiple keywords separated by commas)">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="statusFilter">Status:</label>
                    <select id="statusFilter" class="form-control">
                        <option value="">All Statuses</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="finished">Finished</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="categoryFilter">Category:</label>
                    <select id="categoryFilter" class="form-control">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="dateFilter">Date Range:</label>
                    <select id="dateFilter" class="form-control">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                
                <button onclick="clearFilters()" class="btn btn-warning">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
        </div>

        <!-- New Issue Form -->
        <div class="collapsible-header" onclick="toggleSection('issueForm')">
            <h2><i class="fas fa-plus-circle"></i> Create New Issue</h2>
            <i class="fas fa-chevron-down chevron" id="issueFormChevron"></i>
        </div>
        <div id="issueForm" class="collapsible-content">
            <form id="newIssueForm" class="issue-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="issueTitle">Issue Title <span style="color: var(--error);">*</span></label>
                        <input type="text" id="issueTitle" class="form-control" placeholder="Enter issue title..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="issueCategory">Category</label>
                        <select id="issueCategory" class="form-control">
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="improvement">Improvement</option>
                            <option value="question">Question</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="issueContent">Issue Description <span style="color: var(--error);">*</span></label>
                    <textarea id="issueContent" class="form-control" placeholder="Describe the issue in detail..." required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="resolutionMethod">Resolution Method</label>
                        <input type="text" id="resolutionMethod" class="form-control" placeholder="How will this be resolved?">
                    </div>
                    
                    <div class="form-group">
                        <label for="expectedDate">Expected Resolution Date</label>
                        <input type="date" id="expectedDate" class="form-control">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="actualDate">Actual Resolution Date</label>
                        <input type="date" id="actualDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="issueStatus">Status</label>
                        <select id="issueStatus" class="form-control">
                            <option value="ongoing">Ongoing</option>
                            <option value="finished">Finished</option>
                        </select>
                    </div>
                </div>

                <!-- Media Upload Section -->
                <div class="media-section">
                    <h3><i class="fas fa-paperclip"></i> Attachments</h3>
                    
                    <!-- Image Upload -->
                    <div class="media-upload" id="imageDropZone">
                        <i class="fas fa-images" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.6;"></i>
                        <p>Drag & drop images here or <button type="button" onclick="document.getElementById('imageInput').click()" class="btn" style="display: inline;">Browse Images</button></p>
                        <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                    </div>
                    <div id="imagePreview" class="media-preview"></div>

                    <!-- Voice Recording -->
                    <div class="voice-section">
                        <h4><i class="fas fa-microphone"></i> Voice Recording</h4>
                        <div class="audio-controls">
                            <button type="button" id="recordBtn" class="record-btn" onclick="toggleRecording()">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <span id="recordingStatus">Click to start recording</span>
                            <span id="recordingTime">00:00</span>
                        </div>
                        <div id="audioPreview" class="media-preview"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> Create Issue
                    </button>
                    <button type="button" onclick="clearForm()" class="btn btn-warning">
                        <i class="fas fa-undo"></i> Clear Form
                    </button>
                    <button type="button" onclick="saveAsDraft()" class="btn btn-success">
                        <i class="fas fa-file-alt"></i> Save as Draft
                    </button>
                </div>
            </form>
        </div>

        <!-- Issues Display Section -->
        <div class="issues-section">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> Issues (<span id="issueCount">0</span>)</h2>
                <div class="view-controls">
                    <button onclick="changeView('grid')" class="btn" id="gridViewBtn">
                        <i class="fas fa-th"></i> Grid
                    </button>
                    <button onclick="changeView('list')" class="btn" id="listViewBtn">
                        <i class="fas fa-list"></i> List
                    </button>
                </div>
            </div>
            
            <div id="issuesContainer" class="issues-container grid-view">
                <!-- Issues will be loaded here -->
            </div>
            
            <div id="noIssues" class="no-issues" style="display: none;">
                <i class="fas fa-inbox" style="font-size: 4rem; opacity: 0.3; margin-bottom: 20px;"></i>
                <p>No issues found matching your criteria.</p>
                <button onclick="clearFilters()" class="btn">Clear Filters</button>
            </div>
        </div>

        <!-- Category Management -->
        <div class="collapsible-header" onclick="toggleSection('categoryManagement')">
            <h2><i class="fas fa-tags"></i> Category Management</h2>
            <i class="fas fa-chevron-down chevron" id="categoryManagementChevron"></i>
        </div>
        <div id="categoryManagement" class="collapsible-content">
            <div class="category-form">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="newCategoryName" class="form-control" placeholder="Category name...">
                    </div>
                    <div class="form-group">
                        <input type="color" id="newCategoryColor" class="form-control" value="#4a9b7e">
                    </div>
                    <button onclick="addCategory()" class="btn">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                </div>
            </div>
            <div id="categoriesList" class="categories-list">
                <!-- Categories will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <style>
        .search-filter-section {
            margin-bottom: 30px;
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #ffffff;
        }

        .issue-form {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .media-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .media-section h3, .media-section h4 {
            margin-bottom: 20px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-section {
            margin-top: 30px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .form-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .view-controls {
            display: flex;
            gap: 10px;
        }

        .view-controls .btn {
            padding: 8px 16px;
            min-width: auto;
        }

        .issues-container {
            margin-bottom: 30px;
        }

        .issues-container.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .issues-container.list-view {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .issues-container.list-view .issue-card {
            margin-bottom: 0;
        }

        .no-issues {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.7;
        }

        .category-form {
            margin-bottom: 20px;
        }

        .categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .category-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .delete-category {
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recording {
            background: var(--error) !important;
            animation: pulse 1s infinite;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                min-width: auto;
            }
            
            .section-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .view-controls {
                justify-content: center;
            }
        }
    </style>

    <script>
        // Global variables
        let githubToken = '';
        let isOnline = false;
        let issues = [];
        let categories = {};
        let filteredIssues = [];
        let currentView = 'grid';
        let mediaRecorder = null;
        let recordingChunks = [];
        let recordingTimer = null;
        let recordingStartTime = 0;
        let attachedImages = [];
        let attachedAudio = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
        });

        function initializePage() {
            // Check for stored token
            const storedToken = localStorage.getItem('githubToken');
            if (storedToken) {
                githubToken = storedToken;
                validateToken();
            } else {
                document.getElementById('tokenModal').style.display = 'flex';
            }

            // Load local data
            loadLocalData();
            populateFilterOptions();
            displayIssues();
            displayCategories();
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // Filter controls
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
            
            // Form submission
            document.getElementById('newIssueForm').addEventListener('submit', handleFormSubmit);
            
            // Image upload
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);
            
            // Drag and drop
            const dropZone = document.getElementById('imageDropZone');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
        }

        function authenticateToken() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                showNotification('Please enter a valid GitHub token', 'error');
                return;
            }

            githubToken = token;
            localStorage.setItem('githubToken', token);
            document.getElementById('tokenModal').style.display = 'none';
            
            validateToken();
        }

        function continueOffline() {
            document.getElementById('tokenModal').style.display = 'none';
            isOnline = false;
            showNotification('Running in offline mode', 'warning');
        }

        async function validateToken() {
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    isOnline = true;
                    showNotification('GitHub connection established', 'success');
                } else {
                    throw new Error('Invalid token');
                }
            } catch (error) {
                isOnline = false;
                showNotification('GitHub connection failed. Running offline.', 'warning');
            }
        }

        function loadLocalData() {
            const storedIssues = localStorage.getItem('issues');
            const storedCategories = localStorage.getItem('categories');

            if (storedIssues) {
                issues = JSON.parse(storedIssues);
            }

            if (storedCategories) {
                categories = JSON.parse(storedCategories);
            } else {
                // Default categories
                categories = {
                    'bug': { name: 'Bug Reports', color: '#f44336' },
                    'feature': { name: 'Feature Requests', color: '#2196f3' },
                    'improvement': { name: 'Improvements', color: '#ff9800' },
                    'question': { name: 'Questions', color: '#9c27b0' },
                    'other': { name: 'Other', color: '#607d8b' }
                };
                localStorage.setItem('categories', JSON.stringify(categories));
            }

            filteredIssues = [...issues];
        }

        function populateFilterOptions() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            const issueCategory = document.getElementById('issueCategory');
            issueCategory.innerHTML = '';

            for (const [key, category] of Object.entries(categories)) {
                // Filter dropdown
                const option1 = document.createElement('option');
                option1.value = key;
                option1.textContent = category.name;
                categoryFilter.appendChild(option1);

                // Form dropdown
                const option2 = document.createElement('option');
                option2.value = key;
                option2.textContent = category.name;
                issueCategory.appendChild(option2);
            }
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            applyFilters();
        }

        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredIssues = issues.filter(issue => {
                // Search filter with fuzzy matching
                if (searchQuery) {
                    const searchTerms = searchQuery.split(',').map(term => term.trim());
                    const searchText = `${issue.title} ${issue.content}`.toLowerCase();
                    
                    const matches = searchTerms.some(term => {
                        if (term.length === 0) return true;
                        
                        // Fuzzy matching - allow some character differences
                        for (let i = 0; i <= searchText.length - term.length; i++) {
                            const substring = searchText.substring(i, i + term.length);
                            let differences = 0;
                            for (let j = 0; j < term.length; j++) {
                                if (term[j] !== substring[j]) differences++;
                            }
                            // Allow up to 20% character differences for fuzzy matching
                            if (differences <= Math.floor(term.length * 0.2)) {
                                return true;
                            }
                        }
                        
                        // Exact substring match
                        return searchText.includes(term);
                    });
                    
                    if (!matches) return false;
                }

                // Status filter
                if (statusFilter && issue.status !== statusFilter) {
                    return false;
                }

                // Category filter
                if (categoryFilter && issue.category !== categoryFilter) {
                    return false;
                }

                // Date filter
                if (dateFilter) {
                    const issueDate = new Date(issue.dateTime);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            if (issueDate.toDateString() !== now.toDateString()) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (issueDate < weekAgo) return false;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            if (issueDate < monthAgo) return false;
                            break;
                        case 'year':
                            const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                            if (issueDate < yearAgo) return false;
                            break;
                    }
                }

                return true;
            });

            displayIssues();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filteredIssues = [...issues];
            displayIssues();
        }

        function displayIssues() {
            const container = document.getElementById('issuesContainer');
            const noIssues = document.getElementById('noIssues');
            const issueCount = document.getElementById('issueCount');

            issueCount.textContent = filteredIssues.length;

            if (filteredIssues.length === 0) {
                container.style.display = 'none';
                noIssues.style.display = 'block';
                return;
            }

            container.style.display = currentView === 'grid' ? 'grid' : 'flex';
            noIssues.style.display = 'none';
            container.innerHTML = '';

            filteredIssues
                .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime))
                .forEach(issue => {
                    const issueCard = createIssueCard(issue);
                    container.appendChild(issueCard);
                });
        }

        function createIssueCard(issue) {
            const card = document.createElement('div');
            card.className = 'issue-card';
            card.onclick = () => window.location.href = `issueviewer.html?id=${issue.id}`;

            const statusClass = issue.status === 'ongoing' ? 'status-ongoing' : 'status-finished';
            const formattedDate = new Date(issue.dateTime).toLocaleDateString();
            const categoryName = categories[issue.category]?.name || issue.category || 'Other';

            // Media indicators
            const mediaIndicators = [];
            if (issue.pictures && issue.pictures.length > 0) {
                mediaIndicators.push(`<i class="fas fa-image"></i> ${issue.pictures.length}`);
            }
            if (issue.voiceRecords && issue.voiceRecords.length > 0) {
                mediaIndicators.push(`<i class="fas fa-microphone"></i> ${issue.voiceRecords.length}`);
            }

            card.innerHTML = `
                <div class="issue-title">${escapeHtml(issue.title)}</div>
                <div class="issue-meta">
                    <span class="meta-item ${statusClass}">${issue.status}</span>
                    <span class="meta-item">${formattedDate}</span>
                    <span class="meta-item">${categoryName}</span>
                    ${mediaIndicators.length > 0 ? `<span class="meta-item">${mediaIndicators.join(' ')}</span>` : ''}
                </div>
                <div class="issue-content">${escapeHtml(issue.content.substring(0, 150))}${issue.content.length > 150 ? '...' : ''}</div>
                ${issue.resolutionMethod ? `<div class="issue-resolution"><strong>Resolution:</strong> ${escapeHtml(issue.resolutionMethod)}</div>` : ''}
                ${issue.expectedResolutionDate ? `<div class="issue-dates"><strong>Expected:</strong> ${new Date(issue.expectedResolutionDate).toLocaleDateString()}</div>` : ''}
            `;

            return card;
        }

        function changeView(view) {
            currentView = view;
            const container = document.getElementById('issuesContainer');
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');

            if (view === 'grid') {
                container.className = 'issues-container grid-view';
                gridBtn.style.background = 'linear-gradient(135deg, var(--accent-orange), var(--accent-pink))';
                listBtn.style.background = 'linear-gradient(135deg, var(--light-green), var(--pastel-mint))';
            } else {
                container.className = 'issues-container list-view';
                listBtn.style.background = 'linear-gradient(135deg, var(--accent-orange), var(--accent-pink))';
                gridBtn.style.background = 'linear-gradient(135deg, var(--light-green), var(--pastel-mint))';
            }

            displayIssues();
        }

        function handleFormSubmit(e) {
            e.preventDefault();

            const title = document.getElementById('issueTitle').value.trim();
            const content = document.getElementById('issueContent').value.trim();
            const category = document.getElementById('issueCategory').value;
            const resolutionMethod = document.getElementById('resolutionMethod').value.trim();
            const expectedDate = document.getElementById('expectedDate').value;
            const actualDate = document.getElementById('actualDate').value;
            const status = document.getElementById('issueStatus').value;

            if (!title || !content) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const newIssue = {
                id: Date.now().toString(),
                title: title,
                content: content,
                category: category,
                resolutionMethod: resolutionMethod,
                expectedResolutionDate: expectedDate,
                actualResolutionDate: actualDate,
                status: status,
                dateTime: new Date().toISOString(),
                pictures: [...attachedImages],
                voiceRecords: [...attachedAudio]
            };

            issues.push(newIssue);
            saveToLocalStorage();
            
            if (isOnline) {
                syncToGitHub(newIssue);
            }

            clearForm();
            applyFilters();
            showNotification('Issue created successfully!', 'success');
        }

        function clearForm() {
            document.getElementById('newIssueForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('audioPreview').innerHTML = '';
            attachedImages = [];
            attachedAudio = [];
            stopRecording();
        }

        function saveAsDraft() {
            const draftData = {
                title: document.getElementById('issueTitle').value,
                content: document.getElementById('issueContent').value,
                category: document.getElementById('issueCategory').value,
                resolutionMethod: document.getElementById('resolutionMethod').value,
                expectedDate: document.getElementById('expectedDate').value,
                actualDate: document.getElementById('actualDate').value,
                status: document.getElementById('issueStatus').value,
                images: attachedImages,
                audio: attachedAudio
            };

            localStorage.setItem('issueDraft', JSON.stringify(draftData));
            showNotification('Draft saved successfully!', 'success');
        }

        function loadDraft() {
            const draft = localStorage.getItem('issueDraft');
            if (draft) {
                const draftData = JSON.parse(draft);
                document.getElementById('issueTitle').value = draftData.title || '';
                document.getElementById('issueContent').value = draftData.content || '';
                document.getElementById('issueCategory').value = draftData.category || 'bug';
                document.getElementById('resolutionMethod').value = draftData.resolutionMethod || '';
                document.getElementById('expectedDate').value = draftData.expectedDate || '';
                document.getElementById('actualDate').value = draftData.actualDate || '';
                document.getElementById('issueStatus').value = draftData.status || 'ongoing';
                
                if (draftData.images) {
                    attachedImages = draftData.images;
                    updateImagePreview();
                }
                
                if (draftData.audio) {
                    attachedAudio = draftData.audio;
                    updateAudioPreview();
                }

                showNotification('Draft loaded successfully!', 'success');
            }
        }

        function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            processImageFiles(files);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const files = Array.from(e.dataTransfer.files).filter(file => 
                file.type.startsWith('image/')
            );
            
            if (files.length > 0) {
                processImageFiles(files);
            }
        }

        function processImageFiles(files) {
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showNotification(`File ${file.name} is too large (max 5MB)`, 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        name: file.name,
                        data: e.target.result,
                        type: file.type,
                        size: file.size
                    };
                    
                    attachedImages.push(imageData);
                    updateImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';

            attachedImages.forEach((image, index) => {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'media-item';
                
                imageContainer.innerHTML = `
                    <img src="${image.data}" alt="${image.name}">
                    <button class="remove-media" onclick="removeImage(${index})">×</button>
                `;
                
                preview.appendChild(imageContainer);
            });
        }

        function removeImage(index) {
            attachedImages.splice(index, 1);
            updateImagePreview();
        }

        function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordingChunks = [];

                mediaRecorder.ondataavailable = function(e) {
                    recordingChunks.push(e.data);
                };

                mediaRecorder.onstop = function() {
                    const blob = new Blob(recordingChunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const audioData = {
                            name: `recording_${Date.now()}.wav`,
                            data: e.target.result,
                            type: 'audio/wav',
                            size: blob.size
                        };
                        
                        attachedAudio.push(audioData);
                        updateAudioPreview();
                    };
                    reader.readAsDataURL(blob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                recordBtn.classList.add('recording');
                
                document.getElementById('recordingStatus').textContent = 'Recording...';
                
                recordingTimer = setInterval(updateRecordingTime, 1000);
                
            } catch (error) {
                showNotification('Could not access microphone', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            recordBtn.classList.remove('recording');
            
            document.getElementById('recordingStatus').textContent = 'Click to start recording';
            document.getElementById('recordingTime').textContent = '00:00';
            
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateAudioPreview() {
            const preview = document.getElementById('audioPreview');
            preview.innerHTML = '';

            attachedAudio.forEach((audio, index) => {
                const audioContainer = document.createElement('div');
                audioContainer.className = 'media-item';
                
                audioContainer.innerHTML = `
                    <audio controls src="${audio.data}"></audio>
                    <button class="remove-media" onclick="removeAudio(${index})">×</button>
                    <p style="margin-top: 5px; font-size: 0.9rem;">${audio.name}</p>
                `;
                
                preview.appendChild(audioContainer);
            });
        }

        function removeAudio(index) {
            attachedAudio.splice(index, 1);
            updateAudioPreview();
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const color = document.getElementById('newCategoryColor').value;

            if (!name) {
                showNotification('Please enter a category name', 'error');
                return;
            }

            const key = name.toLowerCase().replace(/\s+/g, '_');
            if (categories[key]) {
                showNotification('Category already exists', 'error');
                return;
            }

            categories[key] = { name: name, color: color };
            localStorage.setItem('categories', JSON.stringify(categories));
            
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryColor').value = '#4a9b7e';
            
            populateFilterOptions();
            displayCategories();
            showNotification('Category added successfully!', 'success');
        }

        function displayCategories() {
            const list = document.getElementById('categoriesList');
            list.innerHTML = '';

            for (const [key, category] of Object.entries(categories)) {
                const item = document.createElement('div');
                item.className = 'category-item';
                
                item.innerHTML = `
                    <div class="category-color" style="background-color: ${category.color};"></div>
                    <span>${category.name}</span>
                    <button class="delete-category" onclick="deleteCategory('${key}')">×</button>
                `;
                
                list.appendChild(item);
            }
        }

        function deleteCategory(key) {
            if (confirm(`Are you sure you want to delete the category "${categories[key].name}"?`)) {
                delete categories[key];
                localStorage.setItem('categories', JSON.stringify(categories));
                populateFilterOptions();
                displayCategories();
                showNotification('Category deleted successfully!', 'success');
            }
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const chevron = document.getElementById(sectionId + 'Chevron');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                chevron.classList.remove('open');
            } else {
                content.classList.add('open');
                chevron.classList.add('open');
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('issues', JSON.stringify(issues));
        }

        async function syncToGitHub(issue) {
            if (!isOnline) return;

            try {
                // Create issue file in GitHub repository
                const filename = `records/issue_${issue.id}.json`;
                const content = btoa(encodeURIComponent(JSON.stringify(issue, null, 2)));

                const response = await fetch(`https://api.github.com/repos/trunkthegreat/issue-tracker/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add issue: ${issue.title}`,
                        content: content,
                        encoding: 'base64'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to sync to GitHub');
                }

                showNotification('Issue synced to GitHub successfully!', 'success');
            } catch (error) {
                showNotification('Failed to sync to GitHub: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize grid view as default
        changeView('grid');
        
        // Load draft on page load if exists
        const draft = localStorage.getItem('issueDraft');
        if (draft) {
            setTimeout(() => {
                if (confirm('A saved draft was found. Would you like to load it?')) {
                    loadDraft();
                    toggleSection('issueForm'); // Open the form section
                }
            }, 1000);
        }
    </script>
</body>
</html>
